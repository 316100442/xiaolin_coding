# 如何加锁

### 加锁的基本单位是 next-key lock (记录锁和间隙锁组合) 前开后闭

> 以下针对MySQL 8.0.26

### 临间锁 (pre_line_number,next_key_number] (相当于锁住更改行到上一行记录范围但不包括上一行)

### 记录锁 [line_number] 相当于仅锁住一条记录

### 间隙锁 (pre_line_number,next_key_number) (相当于锁住了两个实际存在记录之间但不包括上一行和下一行)

### 不同的查找
```
唯一索引等值查询
唯一索引范围查询
非唯一索引等值查询
非唯一索引范围查询
```

### 已经存在的记录
```
id : { 0 , 4 , 8 , 16 , 32 }
b  : { 0 , 4 , 8 , 16 , 32 }
```

### 1.唯一索引等值查询和范围查询

> 唯一索引值存在时，记录锁
> 不存在时，间隙锁

```
where id=16 临键锁 next-key lock 先找到上一个值, 预设临键锁 (8,16]

where id=16因为16是存在的，那么退化为记录锁，仅锁住id=16这一行
where id=10因为10是不存在的，那么退化为间隙锁 (8,16)

where id>=8 and id<9范围查找，找到下一行16,预配(8,16],最终是记录锁 id=8 和间隙锁(8, 16)
```

### 2.非唯一索引等值查询和范围

> 普通索引等值查询，记录存在，next-key lock和间隙锁，不存在，next-key lock退化为间隙锁
> 普通索引范围查询，next-key lock 不会退化为间隙锁和记录锁

```
where b=8 加锁next-key lock (4,8],间隙锁 (8,16)
此时 update where b=4是可以的 (记录锁)
insert (b=4) 会失败,因为insert会查看下一条记录是否加了间隙锁,如果加了会被阻塞,并生成插入意向锁
where b=10 加锁next-key lock(8,16],退化为间隙锁 (8,16)


where b>=8 and b<9 加锁 (4,8] 和 (8,16]
```

### 个人总结 - 唯一索引
```
加锁，首先看是否唯一索引，唯一索引且记录存在时候直接记录锁
不存在时候，锁住该值的上一个和下一个值之间的间隙,也就是间隙锁
范围查找也是记录锁和间隙锁
```
> 唯一索引就是记录锁或者间隙锁 

### 个人总结 - 非唯一索引
```
b=8 有等值，直接会锁住上一条记录和下一条记录[4,8,16]的整个间隙(4,16) 
b=10 无等值，直接间隙锁，(8,16)
范围的话, 直接间隙锁 (4,16)
```

### 唯一索引等值只锁一条记录锁,不然就是间隙锁,范围查找也是间隙锁，但是如果有等值就多一个记录锁

### 非唯一不管等值还是不等值还是范围，直接间隙锁，如果有等值8,那么是8的上一个值和下一个值的间隙锁


### insert会查看下一条记录是否加了间隙锁,如果加了会被阻塞,并生成插入意向锁

### insert会查看下一条记录是否加了间隙锁,如果加了会被阻塞,并生成插入意向锁

### insert会查看下一条记录是否加了间隙锁,如果加了会被阻塞,并生成插入意向锁
