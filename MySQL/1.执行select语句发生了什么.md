# 发生了什么


### MySQL架构分层（自上而下）四大层

1. 网络连接层
2. Server服务层
3. 存储引擎层
4. 系统文件层

### Server服务层分哪些模块 （6个小模块）

1. 连接池
2. 系统管理控制工具（备份恢复、安全管理、集群管理）
3. SQL接口（SQL命令接收）
4. 解析器 （词法分析构建出SQL语法树、语法分析判定语法是否合法）
5. 查询优化器 （解析树转化成执行计划）
6. 缓存

### 解析

1. 连接器

```
基于TCP，先三次握手建立连接，这个就是MySQL连接池
```

2. 查询缓存

```
MySQL语句为k，值为v，表更新就会将缓存删除，索引缓存命中率很低，MySQL8.0 已经删除查询缓存
```

3. 解析SQL

```
词法分析
语法分析
```

4. 执行SQL

```
预处理器

优化器

执行器
    
    主键索引查询

    全表扫描

    索引下推
```

### Server 层每从存储引擎读到一条记录就会发送给客户端 (执行器查询的过程是一个 while 循环 )

### 没有索引下推的时候，每查询到一条二级索引记录，都要进行回表操作


# 备注

1. InnoDB 支持索引类型是 B+树 

2. 查看MySQL服务有多少客户端连接
```
show processlist
```
空闲的时长是 736 秒（ Time 列）

3. 空闲连接会一直占用着吗,不会，有个最大等待时长
```
show variable like 'wait_timeout';
```


[MYSQL架构分层](https://zhuanlan.zhihu.com/p/348234426)